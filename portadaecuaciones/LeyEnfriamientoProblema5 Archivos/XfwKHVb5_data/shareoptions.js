window.GGBT_clb_shareoptions=function($){"use strict";var onCloseFct=null;var modified=false;var _data=null;var _old_edit_sharing_key=null;var _defaults={width:700,height:470};function setData(data,defaults){_data=data;_defaults=$.extend({},_defaults,defaults);if(typeof _data.edit_sharing_key==="string"){_old_edit_sharing_key=_data.edit_sharing_key}}function onResize(){var heigthWOList=$("#popup-sharing-options").height()-$("#pso-accesslist-container").height();if($.modal){$.modal.setContainerDimensions()}}function init(){initButtons();initUserSearch();loadSharedWithList();window.GGBT_clipboard.initClipboardButtons();modified=false;onResize()}function initUserSearch(){var input;jQuery(".adduser-textfield").tokenInput("/user/searchjson",{searchDelay:200,minChars:2,preventDuplicates:true,hintText:$(".adduser-textfield").data("hint"),onReady:function(){input=this;$(".adduser").click(function(){var tokens=input.getTokens();if(tokens.length>0){save(null,tokens)}});$(".adduser-placeholder").click(function(){input.getInputBox().focus()});input.getInputBox().focus(function(){$(".adduser-placeholder").hide()});input.getInputBox().blur(function(){if(!input.getTokens().length){$(".adduser-placeholder").show()}})},onAdd:onResize,onDelete:function(){onResize();input.getInputBox().focus()},tokenFormatter:function(item){if(item.id===0){return'<li><div class="adduser-token-email"></div><span class="token-input-username">'+item.name+"</span></li>"}else{return'<li><div class="token-input-userpic" style="background-image: url(\''+item.avatar+'\');"></div><span class="token-input-username">'+item.name+"</span></li>"}},resultsFormatter:function(item){return'<li><div class="token-input-userpic" style="background-image: url(\''+item.avatar+'\');"></div><span class="token-input-username">'+item[this.propertyToSearch]+"</span></li>"}})}function save(onSuccess,newUserTokens){var data={users:[]};if(newUserTokens!==null&&newUserTokens!==undefined){for(var i=0;i<newUserTokens.length;i++){data.users.push({user_id:newUserTokens[i].id,isNew:true,user_right:"E"})}}var userlist=$(".pso_sharedwithlist");$(".pso_sharedwithitem.ismodified, .pso_sharedwithitem.isnew, .pso_sharedwithitem.isdeleted",userlist).each(function(){var item=$(this);var user={user_id:item.data("user_id")};if(item.hasClass("isdeleted")){user.isDeleted=true}else if(item.hasClass("isnew")){user.isNew=true}else if(item.hasClass("ismodified")){user.isModified=true}user.user_right=$(".pso_user_access_select",item).val();data.users.push(user)});var fail=function(result){window.GGBT_gen_edit.setSaveStateError(result.message)};var success=function(result){var error=false;if(typeof result=="string"){$(".pso-visibility-select").closest("#ggt-popup-content").html(result);init();modified=true}else if(result.type==="error"){error=true;fail(result)}else{var userlist=$(".pso_sharedwithlist");$(".pso_sharedwithitem",userlist).removeClass("ismodified").removeClass("isnew").removeClass("isdeleted")}if(!error){if(typeof onSuccess=="function"){onSuccess()}window.GGBT_gen_edit.setSaveStateSuccessful()}};window.GGBT_gen_edit.setSaveStateInProgress();window.GGBT_spinner.attachSpinner();$.post($("#popup-sharing-options, #pso-accesslist-container").data("usersaveurl"),{data:data},success).fail(fail).always(function(){window.GGBT_spinner.removeSpinner()})}function close(){window.GGBT_gen_modal.closePopup();if(typeof onCloseFct==="function"){onCloseFct(modified)}}function initButtons(){$(".pso-visibility-select").off("change").change(function(){function submit(outer_this){var success=function(result){if(typeof result==="string"){$(outer_this).parents("#ggt-popup-content").html(result);init();modified=true;if(window.GGBT_wsf_edit){$("#wsf-meta-visibility").val($(".pso-visibility-select").val())}window.GGBT_gen_edit.setSaveStateSuccessful()}else{fail(result)}};var fail=function(result){if(result.message!==undefined){window.GGBT_gen_edit.setSaveStateError(result.message)}};window.GGBT_gen_edit.setSaveStateInProgress();window.GGBT_spinner.attachSpinner();$.post($(outer_this).data("url"),{visibility:$(outer_this).val()},success).fail(fail).always(function(){window.GGBT_spinner.removeSpinner()});return false}if(hasPrivateMaterials&&originalVisibility==="P"&&$("input:radio[name='visibility']:checked").val()!=="P"){if(confirm(confirm_share_materials)){submit(this)}}else{submit(this)}});$("#pso_btn_editlink").click(function(e){e.preventDefault();if(!$(this).hasClass("disabled")){var success=function(result){if(typeof result=="string"){$(".pso-visibility-select").parents("#ggt-popup-content").html(result);init();modified=true;window.GGBT_gen_edit.setSaveStateSuccessful(result.message)}else{fail(result)}};var fail=function(result){if(result.message!==undefined){window.GGBT_gen_edit.setSaveStateError(result.message)}};window.GGBT_gen_edit.setSaveStateInProgress();window.GGBT_spinner.attachSpinner();var action=$(this).is(":checked")?"on":"off";$.get($("#pso_btn_editlink").data("url"),{switch:action,edit_sharing_key:_old_edit_sharing_key},success).fail(fail).always(function(){window.GGBT_spinner.removeSpinner()})}return false});$("#popup-sharing-options .done-btn").click(function(){close();return false});$(".btn_advanced_access_settings").click(function(){$("#pso-accesslist-container").show();$(this).hide();$(".pso-visibility-select").data("url",$(".pso-visibility-select").data("url")+"/sharedwithlistexpanded/true");$("#pso_btn_editlink").data("url",$("#pso_btn_editlink").data("url")+"/sharedwithlistexpanded/true");$(window).trigger("resize")})}function initUserItemControls(item){$(".pso_user_access_select",item).change(function(){var item=$(this).parents(".pso_sharedwithitem");item.addClass("ismodified");save()});$(".pso_group_access_select",item).change(function(){var materialId=item.data("material_id");var right=item.find(".pso_group_access_select").val();var url=item.parents("#pso-accesslist-container").data("groupsaveurl")+item.find(".pso_group_access_select").data("id")+"/right/"+right+"/mi/"+materialId;window.GGBT_gen_edit.setSaveStateInProgress();$.get(url,function(response){$("li[data-id="+materialId+"] a.btn_editing_permissions_popup").data("right",right);if(response.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful()}else{window.GGBT_gen_edit.setSaveStateError(response.message)}}).fail(function(response){window.GGBT_gen_edit.setSaveStateError(response.responseText)})});$(".pso_useritem_remove",item).click(function(){var item=$(this).parents(".pso_sharedwithitem");if(item.hasClass("isnew")){item.remove()}else{item.addClass("isdeleted");item.hide()}$(window).trigger("resize");var userCount=$(".pso_sharedwithlist .pso_sharedwithitem").not(".isdeleted").not("#pso_useritem_creator").length-1;$("#pso-private-desc-no-users").toggle(userCount===0);$("#pso-private-desc-users").toggle(userCount>0);save()})}function loadSharedWithList(){if(typeof _data.users=="object"){$(".pso_sharedwithlist").find(".pso_sharedwithitem").not("#pso_useritem_creator, #pso_useritem_template, #pso_groupitem_template").remove();var share_names="";var name_count=3;for(var i=0;i<_data.users.length;i++){addSharingItemToList(_data.users[i].user_id,_data.users[i].username,_data.users[i].user_right,_data.users[i].avatarURL,_data.users[i].profileURL,false,false);if(name_count-- >0){share_names+=_data.users[i].username+", "}}if(typeof _data.groups=="object"){var group=$("#pso_groupitem_template").data("group");for(var i=0;i<_data.groups.length;i++){addSharingItemToList(_data.groups[i].sharing_key,_data.groups[i].title+" ("+group+")",_data.groups[i].user_right,null,_data.groups[i].sharingURL,false,true);if(name_count-- >0){share_names+=_data.groups[i].title+", "}}}var shared_list=$("#pso-shared-list");if($("#pso-accesslist-container").css("display")=="none"){if(shared_list.length){shared_list.text(shared_list.data(name_count>0?"text_little":"text_many").replace("{$1}",share_names.substr(0,share_names.length-2)))}shared_list.toggle(share_names.length>0)}}}function addSharingItemToList(id,title,access,avatarURL,url,isNew,isGroup){var item;if(isNew){$(".pso_sharedwithlist .pso_sharedwithitem").each(function(){if($(this).data("user_id")==id){item=$(this);item.removeClass("isdeleted");item.addClass("ismodified");if(item.attr("id")==="pso_useritem_creator"){return item}}})}if(item===undefined){item=$(isGroup?"#pso_groupitem_template":"#pso_useritem_template").clone();item.attr("id","");item.data("user_id",id);$(".pso_sharedwithlist").append(item);if(isNew){item.addClass("isnew")}}if(!isGroup){$(".avatar",item).attr("style","background-image: url('"+avatarURL+"');")}$(".thumbnails",item).attr("href",url);$(".jUsername a",item).attr("href",url);$(".jUsername a",item).text(title);$(".pso_access_select",item).val(access);if(_data.loggedin_user_id==id){$(".pso_access_select",item).prop("disabled","disabled");$(".pso_useritem_remove",item).remove()}else if(_data.visibility==="O"){$(".pso_user_access_select option[value=V]",item).hide()}if(isGroup){item.find(".pso_group_access_select").data("id",id)}item.show();initUserItemControls(item);$("#pso-private-desc-no-users").hide();$("#pso-private-desc-users").show();return item}function showSharoptionsPopup(button,onClose){onCloseFct=onClose;var url=button.data("url");window.GGBT_gen_modal.showAjaxPopup(url,{id:button.data("id"),type:button.data("type")},{minWidth:_defaults.width,autoResize:true},button.data("title"),null,function(){window.GGBT_clb_shareoptions.init()})}return{init:init,setData:setData,showSharoptionsPopup:showSharoptionsPopup}}(jQuery);